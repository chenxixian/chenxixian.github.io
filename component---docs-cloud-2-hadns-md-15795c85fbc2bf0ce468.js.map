{"version":3,"sources":["webpack:///../docs/cloud/2/HADNS.md","webpack:///../docs/cloud/2/N00000001566896320304@1190037-20171217170645561-1428317110.png","webpack:///../docs/cloud/2/N00000001566896320304@20181127102647925.png"],"names":["_frontmatter","layoutProps","MDXLayout","DefaultLayout","MDXContent","components","props","mdxType","parentName","alt","src","require","isMDXComponent","module","exports"],"mappings":"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","file":"component---docs-cloud-2-hadns-md-15795c85fbc2bf0ce468.js","sourcesContent":["import * as React from 'react'\n  /* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsx mdx */\n\nimport DefaultLayout from \"/root/MyNotes-Webapp/node_modules/gatsby-theme-docz/src/base/Layout.js\";\nexport const _frontmatter = {};\n\nconst makeShortcode = name => function MDXDefaultShortcode(props) {\n  console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n  return <div {...props} />;\n};\n\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = DefaultLayout;\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n\n    <h1 {...{\n      \"id\": \"在华为云部署高可用的dns服务\"\n    }}>{`在华为云部署高可用的DNS服务`}</h1>\n    <h2 {...{\n      \"id\": \"需要的技术组件\"\n    }}>{`需要的技术组件`}</h2>\n    <ul>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`华为云弹性服务器`}</p>\n        <p parentName=\"li\">{`推荐使用广州-public里的`}<a parentName=\"p\" {...{\n            \"href\": \"https://console.huaweicloud.com/ecm/?agencyId=05686a1c000010301f3fc012b4130b9f&locale=zh-cn&region=cn-south-1_public#/ims/manager/imsSelfDetail/shareMembers?imageType=systemDiskImage&imageId=a12c349e-243a-49c3-855d-dd0b28bfab31\"\n          }}>{`“CentOS-7.6-Docker-JDK-LVM-SWAP”私有镜像`}</a>{` 申请2台服务器创建：私有镜像基于CentOS 7.6（x86_64-Minimal-1810）的`}<a parentName=\"p\" {...{\n            \"href\": \"https://repo.huaweicloud.com/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1810.iso\"\n          }}>{`ISO光盘`}</a>{`部署，默认配置了`}<a parentName=\"p\" {...{\n            \"href\": \"https://support.huaweicloud.com/trouble-ecs/zh-cn_topic_0175420638.html\"\n          }}>{`SAWP分区`}</a>{`，按LVM分区（`}<a parentName=\"p\" {...{\n            \"href\": \"https://www.cnblogs.com/CGCong/p/9375787.html\"\n          }}>{`Logical_Volume_Manager`}</a>{`方便日后服务运行时可以系统不停机对分区扩容），安装了JDK 1.8 ，Docker 18.0，Docker-compose 1.14.0 ，软件源使用`}<a parentName=\"p\" {...{\n            \"href\": \"https://mirrors.huaweicloud.com/\"\n          }}>{`华为开源镜像站`}</a>{`，参照《`}<a parentName=\"p\" {...{\n            \"href\": \"https://support.huaweicloud.com/bestpractice-ims/zh-cn_topic_0107074486.html\"\n          }}>{`基于VirtualBox使用ISO创建Linux镜像`}</a>{`》创建。`}</p>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`华为云对象存储`}</p>\n        <p parentName=\"li\">{`在华为云`}<a parentName=\"p\" {...{\n            \"href\": \"https://storage.huaweicloud.com/obs\"\n          }}>{`对象存储控制台`}</a>{`中建立 `}<a parentName=\"p\" {...{\n            \"href\": \"https://storage.huaweicloud.com/obs/?agencyId=05686a1c000010301f3fc012b4130b9f&region=cn-south-1_public&locale=zh-cn#/obs/manage/obs-app-backup/summary\"\n          }}>{`obs-app-backup桶`}</a>{`，用来存储2台DNS服务器的共有配置文件（`}<a parentName=\"p\" {...{\n            \"href\": \"https://storage.huaweicloud.com/obs/?agencyId=05686a1c000010301f3fc012b4130b9f&region=cn-south-1_public&locale=zh-cn#/obs/manage/obs-app-backup/object/list?prefix=dnsmasq%2F\"\n          }}>{`dnsmasq.conf`}</a>{`）。\n`}</p>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`域名解析服务`}</p>\n        <p parentName=\"li\">{` 使用dnsmasq对应的docker版本jpillora/dnsmasq。提供简单的web界面可进行DNS的配置管理、日志查看等操作。`}</p>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`反向代理服务`}</p>\n        <p parentName=\"li\">{` Nginx 版本1.16.0 ，反向代理功能需要支持stream模块。`}</p>\n      </li>\n      <li parentName=\"ul\">\n        <p parentName=\"li\">{`高可用软件`}</p>\n        <p parentName=\"li\">{` Keepalived是基于vrrp协议的一款高可用软件，为两台服务器提供一个共同的虚拟ip---VIP，平时VIP在主服务器上，当主服务宕机，VIP就跑到备用服务器上，引导客户端访问流量到备用服务器，从而实现高可用。Keepalived的HA分为抢占模式和非抢占模式，抢占模式即MASTER从故障中恢复后，会将VIP从BACKUP节点中抢占过来。非抢占模式即MASTER恢复后不抢占BACKUP升级为MASTER后的VIP。 本例中采用非抢占模式，这样会避免VIP切换可能造成的服务延迟。`}</p>\n      </li>\n    </ul>\n    <p><img alt=\"1190037-20171217170645561-1428317110.png\" src={require(\"./N00000001566896320304@1190037-20171217170645561-1428317110.png\")} /></p>\n    <h2 {...{\n      \"id\": \"挂载obs-app-backup桶在2台服务器上\"\n    }}>{`挂载obs-app-backup桶(在2台服务器上)`}</h2>\n    <p>{`   参考`}<a parentName=\"p\" {...{\n        \"href\": \"https://git.sgmw.com.cn/chenxixian/obs-newbaojunapp-prod\"\n      }}>{`《新宝骏App的对象存储使用方法》`}</a>{`，挂载obs-app-backup桶到/dns ，可以使用本项目中的`}<a parentName=\"p\" {...{\n        \"href\": \"https://git.sgmw.com.cn/chenxixian/ha-dns/blob/master/mount-obsfs.sh\"\n      }}>{`mount-obsfs.sh`}</a>{`文件（需要自行更新AK/SK）。`}</p>\n    <h2 {...{\n      \"id\": \"部署dnsmasq在2台服务器上\"\n    }}>{`部署Dnsmasq(在2台服务器上)`}</h2>\n    <h3 {...{\n      \"id\": \"创建简单的配置-dnsdnsmasqdnsmasqconf-：\"\n    }}>{`创建简单的配置 /dns/dnsmasq/dnsmasq.conf ：`}</h3>\n    <pre><code parentName=\"pre\" {...{}}>{`#输出查询日志信息\nlog-queries\n#do not use hosts nameservers\n#默认会使用网关server,若需要配置本地局域网自动使用使用本DNS服务，则须将此选项设置为NO\nno-resolv \n#配置使用的服务，即本地查询不到时，可通过此服务依次进行查询解析，可配置多个，一般为已知的或代理的外网DNS服务\nserver=100.125.1.250\nserver=100.125.136.29\nserver=223.5.5.5\n#server=/syq/192.168.248.137\n#explicitly define host-ip mappings\naddress=/dns.sgmw.com.cn/10.14.2.222\n`}</code></pre>\n    <h3 {...{\n      \"id\": \"运行容器：\"\n    }}>{`运行容器：`}</h3>\n    <pre><code parentName=\"pre\" {...{}}>{`docker run \\\\\n    --name dnsmasq \\\\\n    -d \\\\\n    -p 53:53/udp \\\\\n    -p 8080:8080 \\\\\n    -v /dns/dnsmasq/dnsmasq.conf:/etc/dnsmasq.conf \\\\\n    -v /etc/localtime:/etc/localtime:ro \\\\\n    -e \"HTTP_USER=***\" \\\\\n    -e \"HTTP_PASS=***\" \\\\\n    --restart always \\\\\n    jpillora/dnsmasq\n`}</code></pre>\n    <h3 {...{\n      \"id\": \"访问web-ui\"\n    }}>{`访问web UI`}</h3>\n    <pre><code parentName=\"pre\" {...{}}>{`访问http://dns-host:8080，使用帐号/密码登录，进入类似如下界面，可直接修改配置，点击save即可快速生效。\n`}</code></pre>\n    <p><img alt=\"20181127102647925.png\" src={require(\"./N00000001566896320304@20181127102647925.png\")} /></p>\n    <h2 {...{\n      \"id\": \"部署nginx在2台服务器上\"\n    }}>{`部署Nginx(在2台服务器上)`}</h2>\n    <h3 {...{\n      \"id\": \"安装nginx\"\n    }}>{`安装Nginx`}</h3>\n    <pre><code parentName=\"pre\" {...{}}>{`  wget  http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm\n  rpm -ivh nginx-release-centos-7-0.el7.ngx.noarch.rpm\n  yum install nginx -y\n  systemctl start nginx\n  systemctl enable nginx\n`}</code></pre>\n    <h3 {...{\n      \"id\": \"配置nginx\"\n    }}>{`配置Nginx`}</h3>\n    <pre><code parentName=\"pre\" {...{}}>{`  cd /etc/nginx/conf.d/\n  cp nginx.conf nginx.conf.bak\n  nano nginx.conf\n`}</code></pre>\n    <h3 {...{\n      \"id\": \"反向代理配置，复制到nginxconf：\"\n    }}>{`反向代理配置，复制到nginx.conf：`}</h3>\n    <pre><code parentName=\"pre\" {...{}}>{`#user nobody;\nworker_processes 4;\nevents {\nworker_connections 1024;\n}\nstream {\nupstream dns {\nserver 10.14.2.21:5353 weight=1;\nserver 10.14.2.63:5353 weight=1;\n}\nserver {\nlisten 53 udp;\nproxy_connect_timeout 1s;\nproxy_timeout 20s;\nproxy_pass dns;\n}\n}\n\n`}</code></pre>\n    <h3 {...{\n      \"id\": \"启用配置\"\n    }}>{`启用配置`}</h3>\n    <pre><code parentName=\"pre\" {...{}}>{`  nginx -t\n  nginx -s reload\n`}</code></pre>\n    <h2 {...{\n      \"id\": \"keepalived在2台服务器上\"\n    }}>{`Keepalived(在2台服务器上)`}</h2>\n    <h3 {...{\n      \"id\": \"系统环境准备\"\n    }}>{`系统环境准备`}</h3>\n    <pre><code parentName=\"pre\" {...{}}>{`systemctl stop firewalld.service\nsystemctl disable firewalld.service\nsed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/selinux/config\nsetenforce 0\n\n`}</code></pre>\n    <h3 {...{\n      \"id\": \"安装keepalived\"\n    }}>{`安装Keepalived`}</h3>\n    <pre><code parentName=\"pre\" {...{}}>{`  yum install keepalived -y\n  mkdir /etc/keepalived\n  nano /etc/keepalived/keepalived.conf\n`}</code></pre>\n    <h3 {...{\n      \"id\": \"主节点配置\"\n    }}>{`主节点配置`}</h3>\n    <pre><code parentName=\"pre\" {...{}}>{`! Configuration File for keepalived\nglobal_defs {\n    router_id node_01\n}\nvrrp_script chk_nginx {\n    script \"killall -0 nginx && netstat -an | grep :::5353\"\n    interval 1\n    weight - 5\n    fall    3\n    rise    5\n}\nvrrp_instance VI_1 {\n    state MASTER\n    interface eth0\n    virtual_router_id 88 \n        priority 100 \n        advert_int 1 \n    nopreempt\n    authentication {\n        auth_type PASS\n        auth_pass 8888\n    }\n    virtual_ipaddress {\n        10.14.2.222\n    }\n    track_script {\n        chk_nginx\n    }\n}\n\n`}</code></pre>\n    <h3 {...{\n      \"id\": \"备节点配置\"\n    }}>{`备节点配置`}</h3>\n    <pre><code parentName=\"pre\" {...{}}>{`! Configuration File for keepalived\nglobal_defs {\n    router_id node_02\n}\nvrrp_script chk_nginx {\n    script \"killall -0 nginx && netstat -an | grep :::5353\"\n    interval 1\n    weight - 5\n    fall    3\n    rise    5\n}\nvrrp_instance VI_1 {\n    state BACKUP\n    interface eth0\n    virtual_router_id 88 \n        priority 99 \n        advert_int 1 \n    nopreempt\n    authentication {\n        auth_type PASS\n        auth_pass 8888\n    }\n    virtual_ipaddress {\n        10.14.2.222\n    }\n    track_script {\n        chk_nginx\n    }\n}\n\n`}</code></pre>\n    <h3 {...{\n      \"id\": \"启用配置-1\"\n    }}>{`启用配置`}</h3>\n    <pre><code parentName=\"pre\" {...{}}>{`  systemctl start keepalived \n  systemctl enable keepalived\n  systemctl status keepalived -l\n`}</code></pre>\n\n    </MDXLayout>;\n}\n;\nMDXContent.isMDXComponent = true;\n      ","module.exports = __webpack_public_path__ + \"static/N00000001566896320304@1190037-20171217170645561-1428317110-44417a583ae12b894ce3cc03ca2e6a00.png\";","module.exports = __webpack_public_path__ + \"static/N00000001566896320304@20181127102647925-11d69b80c5d9bb2ea16f0b57bf8b7789.png\";"],"sourceRoot":""}