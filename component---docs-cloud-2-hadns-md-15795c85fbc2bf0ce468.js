(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{"8M9o":function(e,n,t){"use strict";t.r(n),t.d(n,"_frontmatter",(function(){return i})),t.d(n,"default",(function(){return b}));t("5hJT"),t("W1QL"),t("K/PF"),t("t91x"),t("75LO"),t("PJhk"),t("mXGw");var a=t("/FXl"),c=t("TjRS");t("aD51");function r(){return(r=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e}).apply(this,arguments)}var i={};void 0!==i&&i&&i===Object(i)&&Object.isExtensible(i)&&!i.hasOwnProperty("__filemeta")&&Object.defineProperty(i,"__filemeta",{configurable:!0,value:{name:"_frontmatter",filename:"docs/cloud/2/HADNS.md"}});var p={_frontmatter:i},s=c.a;function b(e){var n=e.components,c=function(e,n){if(null==e)return{};var t,a,c={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(c[t]=e[t]);return c}(e,["components"]);return Object(a.b)(s,r({},p,c,{components:n,mdxType:"MDXLayout"}),Object(a.b)("h1",{id:"在华为云部署高可用的dns服务"},"在华为云部署高可用的DNS服务"),Object(a.b)("h2",{id:"需要的技术组件"},"需要的技术组件"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"华为云弹性服务器"),Object(a.b)("p",{parentName:"li"},"推荐使用广州-public里的",Object(a.b)("a",r({parentName:"p"},{href:"https://console.huaweicloud.com/ecm/?agencyId=05686a1c000010301f3fc012b4130b9f&locale=zh-cn&region=cn-south-1_public#/ims/manager/imsSelfDetail/shareMembers?imageType=systemDiskImage&imageId=a12c349e-243a-49c3-855d-dd0b28bfab31"}),"“CentOS-7.6-Docker-JDK-LVM-SWAP”私有镜像")," 申请2台服务器创建：私有镜像基于CentOS 7.6（x86_64-Minimal-1810）的",Object(a.b)("a",r({parentName:"p"},{href:"https://repo.huaweicloud.com/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-1810.iso"}),"ISO光盘"),"部署，默认配置了",Object(a.b)("a",r({parentName:"p"},{href:"https://support.huaweicloud.com/trouble-ecs/zh-cn_topic_0175420638.html"}),"SAWP分区"),"，按LVM分区（",Object(a.b)("a",r({parentName:"p"},{href:"https://www.cnblogs.com/CGCong/p/9375787.html"}),"Logical_Volume_Manager"),"方便日后服务运行时可以系统不停机对分区扩容），安装了JDK 1.8 ，Docker 18.0，Docker-compose 1.14.0 ，软件源使用",Object(a.b)("a",r({parentName:"p"},{href:"https://mirrors.huaweicloud.com/"}),"华为开源镜像站"),"，参照《",Object(a.b)("a",r({parentName:"p"},{href:"https://support.huaweicloud.com/bestpractice-ims/zh-cn_topic_0107074486.html"}),"基于VirtualBox使用ISO创建Linux镜像"),"》创建。")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"华为云对象存储"),Object(a.b)("p",{parentName:"li"},"在华为云",Object(a.b)("a",r({parentName:"p"},{href:"https://storage.huaweicloud.com/obs"}),"对象存储控制台"),"中建立 ",Object(a.b)("a",r({parentName:"p"},{href:"https://storage.huaweicloud.com/obs/?agencyId=05686a1c000010301f3fc012b4130b9f&region=cn-south-1_public&locale=zh-cn#/obs/manage/obs-app-backup/summary"}),"obs-app-backup桶"),"，用来存储2台DNS服务器的共有配置文件（",Object(a.b)("a",r({parentName:"p"},{href:"https://storage.huaweicloud.com/obs/?agencyId=05686a1c000010301f3fc012b4130b9f&region=cn-south-1_public&locale=zh-cn#/obs/manage/obs-app-backup/object/list?prefix=dnsmasq%2F"}),"dnsmasq.conf"),"）。\n")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"域名解析服务"),Object(a.b)("p",{parentName:"li"}," 使用dnsmasq对应的docker版本jpillora/dnsmasq。提供简单的web界面可进行DNS的配置管理、日志查看等操作。")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"反向代理服务"),Object(a.b)("p",{parentName:"li"}," Nginx 版本1.16.0 ，反向代理功能需要支持stream模块。")),Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"高可用软件"),Object(a.b)("p",{parentName:"li"}," Keepalived是基于vrrp协议的一款高可用软件，为两台服务器提供一个共同的虚拟ip---VIP，平时VIP在主服务器上，当主服务宕机，VIP就跑到备用服务器上，引导客户端访问流量到备用服务器，从而实现高可用。Keepalived的HA分为抢占模式和非抢占模式，抢占模式即MASTER从故障中恢复后，会将VIP从BACKUP节点中抢占过来。非抢占模式即MASTER恢复后不抢占BACKUP升级为MASTER后的VIP。 本例中采用非抢占模式，这样会避免VIP切换可能造成的服务延迟。"))),Object(a.b)("p",null,Object(a.b)("img",{alt:"1190037-20171217170645561-1428317110.png",src:t("USt0")})),Object(a.b)("h2",{id:"挂载obs-app-backup桶在2台服务器上"},"挂载obs-app-backup桶(在2台服务器上)"),Object(a.b)("p",null,"   参考",Object(a.b)("a",r({parentName:"p"},{href:"https://git.sgmw.com.cn/chenxixian/obs-newbaojunapp-prod"}),"《新宝骏App的对象存储使用方法》"),"，挂载obs-app-backup桶到/dns ，可以使用本项目中的",Object(a.b)("a",r({parentName:"p"},{href:"https://git.sgmw.com.cn/chenxixian/ha-dns/blob/master/mount-obsfs.sh"}),"mount-obsfs.sh"),"文件（需要自行更新AK/SK）。"),Object(a.b)("h2",{id:"部署dnsmasq在2台服务器上"},"部署Dnsmasq(在2台服务器上)"),Object(a.b)("h3",{id:"创建简单的配置-dnsdnsmasqdnsmasqconf-："},"创建简单的配置 /dns/dnsmasq/dnsmasq.conf ："),Object(a.b)("pre",null,Object(a.b)("code",r({parentName:"pre"},{}),"#输出查询日志信息\nlog-queries\n#do not use hosts nameservers\n#默认会使用网关server,若需要配置本地局域网自动使用使用本DNS服务，则须将此选项设置为NO\nno-resolv \n#配置使用的服务，即本地查询不到时，可通过此服务依次进行查询解析，可配置多个，一般为已知的或代理的外网DNS服务\nserver=100.125.1.250\nserver=100.125.136.29\nserver=223.5.5.5\n#server=/syq/192.168.248.137\n#explicitly define host-ip mappings\naddress=/dns.sgmw.com.cn/10.14.2.222\n")),Object(a.b)("h3",{id:"运行容器："},"运行容器："),Object(a.b)("pre",null,Object(a.b)("code",r({parentName:"pre"},{}),'docker run \\\n    --name dnsmasq \\\n    -d \\\n    -p 53:53/udp \\\n    -p 8080:8080 \\\n    -v /dns/dnsmasq/dnsmasq.conf:/etc/dnsmasq.conf \\\n    -v /etc/localtime:/etc/localtime:ro \\\n    -e "HTTP_USER=***" \\\n    -e "HTTP_PASS=***" \\\n    --restart always \\\n    jpillora/dnsmasq\n')),Object(a.b)("h3",{id:"访问web-ui"},"访问web UI"),Object(a.b)("pre",null,Object(a.b)("code",r({parentName:"pre"},{}),"访问http://dns-host:8080，使用帐号/密码登录，进入类似如下界面，可直接修改配置，点击save即可快速生效。\n")),Object(a.b)("p",null,Object(a.b)("img",{alt:"20181127102647925.png",src:t("cbEw")})),Object(a.b)("h2",{id:"部署nginx在2台服务器上"},"部署Nginx(在2台服务器上)"),Object(a.b)("h3",{id:"安装nginx"},"安装Nginx"),Object(a.b)("pre",null,Object(a.b)("code",r({parentName:"pre"},{}),"  wget  http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm\n  rpm -ivh nginx-release-centos-7-0.el7.ngx.noarch.rpm\n  yum install nginx -y\n  systemctl start nginx\n  systemctl enable nginx\n")),Object(a.b)("h3",{id:"配置nginx"},"配置Nginx"),Object(a.b)("pre",null,Object(a.b)("code",r({parentName:"pre"},{}),"  cd /etc/nginx/conf.d/\n  cp nginx.conf nginx.conf.bak\n  nano nginx.conf\n")),Object(a.b)("h3",{id:"反向代理配置，复制到nginxconf："},"反向代理配置，复制到nginx.conf："),Object(a.b)("pre",null,Object(a.b)("code",r({parentName:"pre"},{}),"#user nobody;\nworker_processes 4;\nevents {\nworker_connections 1024;\n}\nstream {\nupstream dns {\nserver 10.14.2.21:5353 weight=1;\nserver 10.14.2.63:5353 weight=1;\n}\nserver {\nlisten 53 udp;\nproxy_connect_timeout 1s;\nproxy_timeout 20s;\nproxy_pass dns;\n}\n}\n\n")),Object(a.b)("h3",{id:"启用配置"},"启用配置"),Object(a.b)("pre",null,Object(a.b)("code",r({parentName:"pre"},{}),"  nginx -t\n  nginx -s reload\n")),Object(a.b)("h2",{id:"keepalived在2台服务器上"},"Keepalived(在2台服务器上)"),Object(a.b)("h3",{id:"系统环境准备"},"系统环境准备"),Object(a.b)("pre",null,Object(a.b)("code",r({parentName:"pre"},{}),"systemctl stop firewalld.service\nsystemctl disable firewalld.service\nsed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/selinux/config\nsetenforce 0\n\n")),Object(a.b)("h3",{id:"安装keepalived"},"安装Keepalived"),Object(a.b)("pre",null,Object(a.b)("code",r({parentName:"pre"},{}),"  yum install keepalived -y\n  mkdir /etc/keepalived\n  nano /etc/keepalived/keepalived.conf\n")),Object(a.b)("h3",{id:"主节点配置"},"主节点配置"),Object(a.b)("pre",null,Object(a.b)("code",r({parentName:"pre"},{}),'! Configuration File for keepalived\nglobal_defs {\n    router_id node_01\n}\nvrrp_script chk_nginx {\n    script "killall -0 nginx && netstat -an | grep :::5353"\n    interval 1\n    weight - 5\n    fall    3\n    rise    5\n}\nvrrp_instance VI_1 {\n    state MASTER\n    interface eth0\n    virtual_router_id 88 \n        priority 100 \n        advert_int 1 \n    nopreempt\n    authentication {\n        auth_type PASS\n        auth_pass 8888\n    }\n    virtual_ipaddress {\n        10.14.2.222\n    }\n    track_script {\n        chk_nginx\n    }\n}\n\n')),Object(a.b)("h3",{id:"备节点配置"},"备节点配置"),Object(a.b)("pre",null,Object(a.b)("code",r({parentName:"pre"},{}),'! Configuration File for keepalived\nglobal_defs {\n    router_id node_02\n}\nvrrp_script chk_nginx {\n    script "killall -0 nginx && netstat -an | grep :::5353"\n    interval 1\n    weight - 5\n    fall    3\n    rise    5\n}\nvrrp_instance VI_1 {\n    state BACKUP\n    interface eth0\n    virtual_router_id 88 \n        priority 99 \n        advert_int 1 \n    nopreempt\n    authentication {\n        auth_type PASS\n        auth_pass 8888\n    }\n    virtual_ipaddress {\n        10.14.2.222\n    }\n    track_script {\n        chk_nginx\n    }\n}\n\n')),Object(a.b)("h3",{id:"启用配置-1"},"启用配置"),Object(a.b)("pre",null,Object(a.b)("code",r({parentName:"pre"},{}),"  systemctl start keepalived \n  systemctl enable keepalived\n  systemctl status keepalived -l\n")))}void 0!==b&&b&&b===Object(b)&&Object.isExtensible(b)&&!b.hasOwnProperty("__filemeta")&&Object.defineProperty(b,"__filemeta",{configurable:!0,value:{name:"MDXContent",filename:"docs/cloud/2/HADNS.md"}}),b.isMDXComponent=!0},USt0:function(e,n,t){e.exports=t.p+"static/N00000001566896320304@1190037-20171217170645561-1428317110-44417a583ae12b894ce3cc03ca2e6a00.png"},cbEw:function(e,n,t){e.exports=t.p+"static/N00000001566896320304@20181127102647925-11d69b80c5d9bb2ea16f0b57bf8b7789.png"}}]);
//# sourceMappingURL=component---docs-cloud-2-hadns-md-15795c85fbc2bf0ce468.js.map